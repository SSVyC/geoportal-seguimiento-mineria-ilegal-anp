<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>REPORTE DE OPERATIVO (INTERDICCIÓN) EN ANP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Leaflet (MAPA GENERAL) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Proj4js (WGS84 <-> UTM) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.2/proj4.js"></script>

  <style>
    :root{
      --ink:#0b1220; --muted:#475569; --line:#e2e8f0; --bg:#ffffff;
    }
    body{ margin:0; font-family: Arial, sans-serif; background:#f8fafc; color:var(--ink); }
    .page{
      max-width: 980px; margin: 22px auto; background:var(--bg);
      border:1px solid var(--line); border-radius:12px; padding:18px 22px 22px;
    }

    /* ===== Encabezado con logos (MISMO TAMAÑO) ===== */
    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding-bottom:10px; border-bottom:1px solid var(--line);
    }
    .logos{
      width: 75.6mm; height: auto;
      display:block;
    }
    .header-right{
      text-align:right; flex: 1;
    }
    .report-title{
      font-size: 13.5px; font-weight: 800; margin:0;
      letter-spacing: .2px; text-transform: uppercase;
    }
    .report-sub{
      margin-top:4px; font-size:11.5px; color:var(--muted);
    }

    .top-actions{
      display:flex; gap:8px; justify-content:flex-end; margin-top:10px;
    }
    .btn{
      border:1px solid var(--line); background:#0f172a; color:#fff;
      padding:9px 12px; border-radius:10px; cursor:pointer; font-weight:800; font-size:12px;
    }
    .btn.secondary{ background:#334155; }

    h2{ font-size:12.8px; margin:14px 0 8px; }
    .muted{ color:var(--muted); font-size:11.5px; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .box{ border:1px solid var(--line); border-radius:10px; padding:10px; }
    .k{ font-size:11px; color:var(--muted); margin-bottom:3px; }
    .v{ font-size:12.5px; font-weight:800; }
    .v.normal{ font-weight:600; white-space:pre-wrap; }

    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th, td{ border:1px solid var(--line); padding:7px; font-size:11.5px; vertical-align:top; }
    th{ background:#f8fafc; text-align:left; }

    .hr{ border-top:1px solid var(--line); margin:14px 0; }

    /* ===== Mapa general ===== */
    .map-title{ margin:10px 0 6px; font-size:12px; font-weight:800; }
    #map{
      height: 360px; border:1px solid var(--line); border-radius:10px; overflow:hidden;
      background:#f1f5f9;
    }

    /* ===== Impresión ===== */
    @media print{
      body{ background:#fff; }
      .page{ margin:0; border:none; border-radius:0; padding:0; }
      .top-actions{ display:none; }
      #map{ height: 320px; }
    }
  </style>
</head>

<body>
  <div class="page">

    <!-- ENCABEZADO (logos + título) -->
    <div class="header">
      <img class="logos" src="assets/logos_header.jpg" alt="Logos institucionales">

      <div class="header-right">
        <p class="report-title" id="repTitle">REPORTE DE OPERATIVO (INTERDICCIÓN) - [ANP]</p>
        <div class="report-sub" id="repSub">Cargando…</div>
      </div>
    </div>

    <div class="top-actions">
      <button class="btn secondary" onclick="window.close()">Cerrar</button>
      <button class="btn" onclick="window.print()">Imprimir / Guardar PDF</button>
    </div>

    <h2>1. Datos del operativo</h2>
    <div class="grid">
      <div class="box">
        <div class="k">ANP</div>
        <div class="v" id="anpNombre">—</div>
        <div class="muted" id="anpCod">—</div>
      </div>

      <div class="box">
        <div class="k">Código de operativo (opera_id)</div>
        <div class="v" id="operaId">—</div>
      </div>

      <div class="box">
        <div class="k">Fecha inicio</div>
        <div class="v" id="fechaIni">—</div>
      </div>

      <div class="box">
        <div class="k">Fecha fin</div>
        <div class="v" id="fechaFin">—</div>
      </div>

      <div class="box">
        <div class="k">Tipo de operativo</div>
        <div class="v" id="tipoOpera">—</div>
      </div>

      <div class="box">
        <div class="k">dete_id asociado (opcional)</div>
        <div class="v" id="deteAsoc">—</div>
      </div>

      <div class="box" style="grid-column:1 / -1;">
        <div class="k">Objetivo</div>
        <div class="v normal" id="objetivo">—</div>
      </div>

      <div class="box" style="grid-column:1 / -1;">
        <div class="k">Resumen</div>
        <div class="v normal" id="resumen">—</div>
      </div>
    </div>

    <h2>2. Instituciones participantes</h2>
    <div class="muted">Relación consolidada de instituciones registradas para el operativo.</div>

    <table>
      <thead>
        <tr>
          <th style="width:44px;">N°</th>
          <th style="width:120px;">Código</th>
          <th>Institución</th>
          <th style="width:100px;">Cantidad</th>
          <th style="width:180px;">Rol</th>
        </tr>
      </thead>
      <tbody id="tblInst">
        <tr><td colspan="5" class="muted">Cargando…</td></tr>
      </tbody>
    </table>

    <h2>3. Ubicaciones registradas</h2>
    <div class="muted">Relación consolidada de ubicaciones del operativo (coordenadas UTM calculadas automáticamente).</div>

    <table>
      <thead>
        <tr>
          <th style="width:44px;">N°</th>
          <th style="width:160px;">opera_ubic_id</th>
          <th style="width:110px;">Zona UTM (WGS84)</th>
          <th style="width:120px;">Este (m)</th>
          <th style="width:120px;">Norte (m)</th>
        </tr>
      </thead>
      <tbody id="tblUbic">
        <tr><td colspan="5" class="muted">Cargando…</td></tr>
      </tbody>
    </table>

    <div class="map-title">MAPA GENERAL DE UBICACIONES</div>
    <div class="muted">(Inserción automática del mapa con los puntos del operativo dentro del ANP)</div>
    <div style="height:8px;"></div>
    <div id="map"></div>

    <h2>4. Componentes interdictados</h2>
    <div class="muted">Resumen de componentes registrados por ubicación.</div>

    <table>
      <thead>
        <tr>
          <th style="width:160px;">opera_ubic_id</th>
          <th>Componente</th>
          <th style="width:90px;">Cantidad</th>
          <th>Descripción</th>
          <th style="width:120px;">Evidencia</th>
        </tr>
      </thead>
      <tbody id="tblComp">
        <tr><td colspan="5" class="muted">Cargando…</td></tr>
      </tbody>
    </table>

    <h2>5. Cierre</h2>
    <div class="grid">
      <div class="box">
        <div class="k">Fecha de emisión</div>
        <div class="v" id="fecEmision">—</div>
      </div>
      <div class="box">
        <div class="k">Elaborado por</div>
        <div class="v" id="elaboradoPor">—</div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="muted">Generado desde el Geoportal. Fecha/hora de generación: <span id="genTime"></span></div>
  </div>

<script>
(function(){
  /* ===== Supabase (igual a tus HTML) ===== */
  const SUPABASE_URL = "https://tewrzarmckrztcrmgfjo.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRld3J6YXJtY2tyenRjcm1nZmpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODQ3NTksImV4cCI6MjA3NzA2MDc1OX0.xeQnYEVAV_eIy7zVxFU9W2Fd0xjuF4v-tQjM2REPtCc";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s ?? "").replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  function qparam(name){ return (new URL(window.location.href)).searchParams.get(name) || ""; }

  /* ===== UTM helpers (igual enfoque que reporte_deteccion) ===== */
  function utmZoneFromLon(lon){ return Math.floor((lon + 180) / 6) + 1; }
  function lonLatToUTM(lon, lat){
    if(!Number.isFinite(lon) || !Number.isFinite(lat)) return null;
    const zone = utmZoneFromLon(lon);
    const hemi = (lat < 0) ? "S" : "N";
    const utmDef = `+proj=utm +zone=${zone} ${lat < 0 ? "+south" : ""} +datum=WGS84 +units=m +no_defs`;
    try{
      const res = proj4("EPSG:4326", utmDef, [lon, lat]);
      return { zona: `${zone}${hemi}`, este: res[0], norte: res[1] };
    }catch(e){
      return null;
    }
  }
  function coordFromGeom(geom){
    try{
      if(!geom) return null;
      if(typeof geom === "string"){
        const m = geom.match(/POINT\(([-\d.]+)\s+([-\d.]+)\)/i);
        if(m) return { lon: Number(m[1]), lat: Number(m[2]) };
      }
      if(geom.type === "Point" && Array.isArray(geom.coordinates)){
        return { lon: geom.coordinates[0], lat: geom.coordinates[1] };
      }
    }catch(e){}
    return null;
  }

  /* ===== Mapa ===== */
  let map, layerPts, layerAnp;

  function initMap(){
    map = L.map("map", { zoomControl:false, attributionControl:false, maxZoom:17 });

    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 17 }
    ).addTo(map);

    layerPts = L.layerGroup().addTo(map);
    layerAnp = L.geoJSON(null, { style:{ color:"#00ffff", weight:2, fill:false } }).addTo(map);

    const peruBounds = L.latLngBounds(L.latLng(-18.35, -81.35), L.latLng(-0.03, -68.65));
    map.fitBounds(peruBounds, { padding:[10,10] });
  }

  function fitToData(boundsList){
    const valid = boundsList.filter(b => b && b.isValid && b.isValid());
    if(!valid.length) return;
    let b = valid[0];
    for(let i=1;i<valid.length;i++) b = b.extend(valid[i]);
    map.fitBounds(b, { padding:[10,10], maxZoom: 15 });
  }

  /* ===== Queries ===== */
  async function getOperativo(opera_id){
    const { data, error } = await sb
      .from("operativo_evento")
      .select("opera_id, anp_cod, fecha_inicio_opera, fecha_fin_opera, tipo_opera, dete_id, objetivo, resumen, usuario_creacion")
      .eq("opera_id", opera_id)
      .maybeSingle();
    if(error) throw error;
    return data;
  }

  async function getANPInfo(anp_cod){
    let r = await sb.from("v_anp_selector")
      .select("anp_cod, anp_nomb, extent_geojson")
      .eq("anp_cod", anp_cod)
      .maybeSingle();

    if(!r.error && r.data) return r.data;

    r = await sb.from("anp_mineria_ilegal")
      .select("anp_cod, anp_nomb, geom")
      .eq("anp_cod", anp_cod)
      .maybeSingle();

    if(r.error) return { anp_cod };
    return r.data || { anp_cod };
  }

  async function getANPGeom(anp_cod){
    const { data, error } = await sb
      .from("anp_mineria_ilegal")
      .select("geom")
      .eq("anp_cod", anp_cod)
      .maybeSingle();
    if(error) return null;
    return data?.geom || null;
  }

  async function getInstituciones(opera_id){
    const { data, error } = await sb
      .from("operativo_evento_institucion")
      .select("inst_cod, cantidad_personal, rol")
      .eq("opera_id", opera_id);

    if(error) throw error;
    const rows = data || [];

    const cods = [...new Set(rows.map(r=>r.inst_cod).filter(Boolean))];
    let dict = {};
    if(cods.length){
      const r2 = await sb
        .from("dom_institucion")
        .select("inst_cod, inst_desc")
        .in("inst_cod", cods);
      if(!r2.error && r2.data){
        r2.data.forEach(d=>{ dict[d.inst_cod] = d.inst_desc; });
      }
    }

    return rows.map(r=>({
      inst_cod: r.inst_cod,
      inst_desc: dict[r.inst_cod] || "",
      cantidad_personal: r.cantidad_personal,
      rol: r.rol
    }));
  }

  async function getUbicaciones(opera_id){
    const { data, error } = await sb
      .from("operativo_ubicacion")
      .select("opera_ubic_id, geom, latitud, longitud")
      .eq("opera_id", opera_id)
      .order("opera_ubic_id", { ascending:true });
    if(error) throw error;
    return data || [];
  }

  async function getComponentesByOpera(opera_id){
    // buscamos ubicaciones primero y luego componentes por in()
    const ubics = await getUbicaciones(opera_id);
    const ids = ubics.map(u=>u.opera_ubic_id).filter(Boolean);
    if(!ids.length) return [];

    const { data, error } = await sb
      .from("operativo_resultado")
      .select("opera_ubic_id, comp_int_cod, cantidad, descripcion, evidencia_url")
      .in("opera_ubic_id", ids);

    if(error) throw error;
    const rows = data || [];

    const cods = [...new Set(rows.map(r=>r.comp_int_cod).filter(Boolean))];
    let dict = {};
    if(cods.length){
      const r2 = await sb
        .from("dom_componente_interdiccion")
        .select("comp_int_cod, comp_int_desc")
        .in("comp_int_cod", cods);
      if(!r2.error && r2.data){
        r2.data.forEach(d=>{ dict[d.comp_int_cod] = d.comp_int_desc; });
      }
    }

    return rows.map(r=>({
      opera_ubic_id: r.opera_ubic_id,
      comp_int_cod: r.comp_int_cod,
      comp_desc: dict[r.comp_int_cod] || "",
      cantidad: r.cantidad,
      descripcion: r.descripcion,
      evidencia_url: r.evidencia_url
    }));
  }

  /* ===== Render ===== */
  function renderInstTable(insts){
    const tb = $("tblInst");
    if(!insts.length){
      tb.innerHTML = `<tr><td colspan="5" class="muted">No se registraron instituciones.</td></tr>`;
      return;
    }
    tb.innerHTML = insts.map((r, i)=>`
      <tr>
        <td>${i+1}</td>
        <td>${esc(r.inst_cod || "—")}</td>
        <td>${esc(r.inst_desc || "")}${r.inst_desc ? ` (${esc(r.inst_cod || "")})` : ""}</td>
        <td>${esc(r.cantidad_personal ?? "—")}</td>
        <td>${esc(r.rol ?? "—")}</td>
      </tr>
    `).join("");
  }

  function renderUbicTable(ubics){
    const tb = $("tblUbic");
    if(!ubics.length){
      tb.innerHTML = `<tr><td colspan="5" class="muted">No hay ubicaciones registradas.</td></tr>`;
      return;
    }

    tb.innerHTML = ubics.map((u, i)=>{
      const cg = coordFromGeom(u.geom);
      const lon = cg?.lon ?? (u.longitud!=null ? Number(u.longitud) : NaN);
      const lat = cg?.lat ?? (u.latitud!=null ? Number(u.latitud) : NaN);

      const utm = lonLatToUTM(lon, lat);
      const zona = utm?.zona || "—";
      const este = (utm?.este!=null) ? utm.este.toFixed(2) : "—";
      const norte = (utm?.norte!=null) ? utm.norte.toFixed(2) : "—";

      return `
        <tr>
          <td>${i+1}</td>
          <td>${esc(u.opera_ubic_id)}</td>
          <td>${esc(zona)}</td>
          <td>${esc(este)}</td>
          <td>${esc(norte)}</td>
        </tr>
      `;
    }).join("");
  }

  function renderCompTable(comps){
    const tb = $("tblComp");
    if(!comps.length){
      tb.innerHTML = `<tr><td colspan="5" class="muted">No hay componentes registrados.</td></tr>`;
      return;
    }

    tb.innerHTML = comps.map(r=>{
      const compName = r.comp_desc ? `${r.comp_desc} (${r.comp_int_cod})` : (r.comp_int_cod || "—");
      const evid = r.evidencia_url
        ? `<a href="${esc(r.evidencia_url)}" target="_blank" rel="noopener noreferrer">abrir</a>`
        : "—";

      return `
        <tr>
          <td>${esc(r.opera_ubic_id)}</td>
          <td>${esc(compName)}</td>
          <td>${esc(r.cantidad ?? "—")}</td>
          <td>${esc(r.descripcion ?? "—")}</td>
          <td>${evid}</td>
        </tr>
      `;
    }).join("");
  }

  function renderMap(anpGeom, ubics){
    layerPts.clearLayers();
    layerAnp.clearLayers();

    const boundsList = [];

    if(anpGeom){
      try{
        layerAnp.addData(anpGeom);
        boundsList.push(L.geoJSON(anpGeom).getBounds());
      }catch(e){}
    }

    ubics.forEach(u=>{
      const c = coordFromGeom(u.geom);
      if(!c) return;

      const lat = c.lat, lon = c.lon;
      if(!Number.isFinite(lat) || !Number.isFinite(lon)) return;

      const m = L.circleMarker([lat, lon], { radius:7, color:"#38bdf8", weight:2, fillOpacity:0.75 });
      m.bindPopup(`<b>opera_ubic_id:</b> ${esc(u.opera_ubic_id)}`);
      layerPts.addLayer(m);

      boundsList.push(L.latLngBounds([lat, lon], [lat, lon]));
    });

    fitToData(boundsList);
  }

  async function main(){
    $("genTime").textContent = new Date().toLocaleString();
    initMap();

    // 1) lee opera_id por querystring y fallback por sessionStorage
    const opera_id =
      qparam("opera_id")
      || sessionStorage.getItem("last_opera_id")
      || sessionStorage.getItem("opera_id")
      || "";

    if(!opera_id){
      $("repSub").textContent = "Falta parámetro opera_id (abre la ficha desde el módulo de Operativos).";
      $("tblInst").innerHTML = `<tr><td colspan="5" class="muted">—</td></tr>`;
      $("tblUbic").innerHTML = `<tr><td colspan="5" class="muted">—</td></tr>`;
      $("tblComp").innerHTML = `<tr><td colspan="5" class="muted">—</td></tr>`;
      return;
    }

    const op = await getOperativo(opera_id);
    if(!op){
      $("repSub").textContent = `No se encontró opera_id: ${opera_id}`;
      return;
    }

    const anpInfo = await getANPInfo(op.anp_cod);
    const anpName = anpInfo?.anp_nomb || sessionStorage.getItem("anp_nombre") || op.anp_cod || "ANP";

    $("repTitle").textContent = `REPORTE DE OPERATIVO (INTERDICCIÓN) - ${anpName}`;
    $("repSub").textContent = `Código: ${opera_id}`;

    $("anpNombre").textContent = anpName;
    $("anpCod").textContent = op.anp_cod ? `Código ANP: ${op.anp_cod}` : "—";

    $("operaId").textContent = op.opera_id || "—";
    $("fechaIni").textContent = op.fecha_inicio_opera || "—";
    $("fechaFin").textContent = op.fecha_fin_opera || "—";
    $("tipoOpera").textContent = op.tipo_opera || "INTERDICCION";
    $("deteAsoc").textContent = op.dete_id || "—";
    $("objetivo").textContent = op.objetivo || "—";
    $("resumen").textContent = op.resumen || "—";

    $("fecEmision").textContent = new Date().toLocaleDateString();
    $("elaboradoPor").textContent = op.usuario_creacion || "—";

    // tablas
    const insts = await getInstituciones(opera_id);
    renderInstTable(insts);

    const ubics = await getUbicaciones(opera_id);
    renderUbicTable(ubics);

    const comps = await getComponentesByOpera(opera_id);
    renderCompTable(comps);

    const anpGeom = await getANPGeom(op.anp_cod);
    renderMap(anpGeom, ubics);

    // Auto-imprimir si ?autoprint=1
    const autoprint = qparam("autoprint");
    if (autoprint === "1") {
      setTimeout(() => window.print(), 350);
    }
  }

  main().catch(err=>{
    $("repSub").textContent = "Error cargando el reporte";
    const m = esc(err?.message || err);
    $("tblInst").innerHTML = `<tr><td colspan="5" class="muted">${m}</td></tr>`;
    $("tblUbic").innerHTML = `<tr><td colspan="5" class="muted">—</td></tr>`;
    $("tblComp").innerHTML = `<tr><td colspan="5" class="muted">—</td></tr>`;
  });
})();
</script>
</body>
</html>
